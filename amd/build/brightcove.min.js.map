{"version":3,"sources":["../src/brightcove.js"],"names":["define","$","Ajax","interval","onPageLoaded","loadBrightCoveJs","accountId","playerId","window","require","config","waitSeconds","html5PlayerGenericPlayerEventListener","player","html5player","cm","cmid","video_id","on","mediainfo","id","console","info","setInterval","currentTime","Math","ceil","log","duration","set_course_module_progress","progress_interval","clearInterval","html5playerSetProgress","results","progress","floor","videoid","ended","promise","call","methodname","args","then","completed","fail","e","get_single_video_course_module_progress","get_playlist_video_progress","response","progresses","length","playlists","playlist","result","index","findIndex","video","currentItem","currentItemIndex","find","html5playerOnLoadSingleVideoMetaData","html5playerOnPlaySingleVideo","html5playerOnLoadPlaylistMetaData","html5playerOnPlayPlaylist","init","initBrightCovePlayer","JSON","parse","account_id","player_id","is_student","myPlayer","videojs","getPlayer","video_type"],"mappings":"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","sourcesContent":["define(['jquery','core/ajax'], function ($, Ajax) {\n\n    let interval;\n\n    let onPageLoaded;\n\n    const VIDEO_TYPE_SINGLE_VIDEO = 1;\n\n    const VIDEO_TYPE_PLAYLIST = 2;\n\n    /**\n     * Load brightcove player javascript.\n     * @param accountId\n     * @param playerId\n     */\n    const loadBrightCoveJs = (accountId, playerId) => {\n        window.require.config({\n            'paths': {\n                'bc': `https://players.brightcove.net/${accountId}/${playerId}_default/index.min`\n            },\n            waitSeconds: 30\n        });\n    }\n\n    /**\n     * Common event listener for brightcove Player.\n     * @param player\n     * @param html5player\n     */\n    const html5PlayerGenericPlayerEventListener = (player, html5player) => {\n        const cm = html5player.cmid;\n        let video_id = html5player.video_id;\n\n        player.on('play',(e)=> {\n            video_id = player.mediainfo.id;\n            console.info(`Video: ${player.mediainfo.id} started playing...`)\n            interval = player.setInterval(function(){\n                const currentTime = Math.ceil(player.currentTime());\n                console.log(`Video playing. Total length: ${player.duration()}. Video current progress is : ${player.currentTime()}`)\n                set_course_module_progress(cm,video_id,currentTime)\n            }, +html5player.progress_interval);\n\n        })\n\n        player.on('pause',(e)=>{\n            player.clearInterval(interval);\n        })\n    }\n\n    /**\n     * @param player\n     * @param results\n     */\n    const html5playerSetProgress = (player, results) => {\n        let progress = results.progress\n        if (progress){\n            const duration = player.duration();\n            const currentTime = Math.floor(progress) / 1000;\n            console.info(`Duration is: ${duration} and Video progress is ${currentTime} seconds`);\n            if(duration >= currentTime){\n                player.currentTime(currentTime);\n            }\n            // else {\n            //     player.currentTime(duration - 1);\n            // }\n        }else {\n            console.info(`Video progress is ${progress}`);\n        }\n    }\n\n    /**\n     * Set course module video progress\n     * @param id\n     * @param videoid\n     * @param progress\n     * @param ended\n     */\n    const set_course_module_progress = (id, videoid, progress, ended=false) => {\n        let promise;\n\n        promise = Ajax.call([{\n            methodname: 'mod_html5player_set_module_progress',\n            args: {\n                id, // course module id.\n                videoid, // Brightcove video id.\n                progress, // Progress percentage\n                ended, // Progress percentage\n            }\n        }]);\n\n        promise[0].then(function(results) {\n            console.info(`Video completed : ${results.completed}`)\n\n        }).fail((e) => {\n            console.log(e)\n        });\n    }\n\n    /**\n     * Get course module single video progress.\n     * @param player\n     * @param html5player\n     */\n    const get_single_video_course_module_progress = (player, html5player) => {\n        let promise;\n\n        console.info(`Geting course video progress from store...`)\n        promise = Ajax.call([{\n            methodname: 'mod_html5player_get_module_progress',\n            args: {\n                id: html5player.cmid, // course module id.\n                videoid: html5player.video_id, // html5videos table PK.\n            }\n        }]);\n\n        promise[0].then(function(results) {\n            console.info(`Fetched result from store`);\n            html5playerSetProgress(player, results);\n        }).fail((e) => {\n            console.log(e)\n        });\n    }\n\n    /**\n     * Get course module single video progress.\n     * @param player\n     * @param html5player\n     */\n    const get_playlist_video_progress = (player, html5player) => {\n        let promise;\n\n        console.info(`Getting course video progresses from store...`)\n        promise = Ajax.call([{\n            methodname: 'mod_html5player_get_module_progresses',\n            args: {\n                id: html5player.cmid, // course module id.\n            }\n        }]);\n\n        promise[0].then(function(response) {\n            console.info(`Fetched module progresses result from store`);\n            if (response.progresses?.length > 0){\n                const playlists = player.playlist();\n                console.log(playlists);\n                let result;\n                if (onPageLoaded){\n                    console.info('Current item progress set after first time dom load...');\n                    result = response.progresses[0];\n                    const index = playlists.findIndex(video => video.id == result.video_id);\n                    if (index>=0){\n                        player.playlist.currentItem(index);\n                        html5playerSetProgress(player, result);\n                        onPageLoaded = false;\n                    }\n                }else {\n                    const currentItemIndex = player.playlist.currentItem();\n                    const currentItem = playlists[currentItemIndex]\n                    result = response.progresses.find(video => video.video_id == currentItem.id )\n                    html5playerSetProgress(player, result);\n                }\n\n            }\n        }).fail((e) => {\n            console.log(e)\n        });\n    }\n\n    /**\n     * On Load meta data event and listener\n     * @param player\n     * @param html5player\n     */\n    const html5playerOnLoadSingleVideoMetaData = (player, html5player) => {\n        player.on('loadedmetadata', function(e){\n            console.info('Single video player meta data loaded...')\n            get_single_video_course_module_progress(player,html5player);\n        });\n    }\n\n    /**\n     * Event listener for single video.\n     * @param player\n     * @param html5player\n     */\n    const html5playerOnPlaySingleVideo = (player,html5player) => {\n        html5PlayerGenericPlayerEventListener(player, html5player);\n\n        player.on('ended',(e)=>{\n            const currentTime = Math.ceil( player.duration());\n            console.log(`Video ended... Video id: ${player.mediainfo.id}, Duration: ${player.duration()}`)\n            set_course_module_progress(html5player.cmid,html5player.video_id,currentTime,true)\n            player.clearInterval(interval);\n        })\n    }\n\n    /**\n     * On load playlists meta data\n     * @param player\n     * @param html5player\n     * @param onpageload\n     */\n    const html5playerOnLoadPlaylistMetaData = (player, html5player) => {\n        player.on('loadedmetadata',(e) => {\n            console.info('playlist videos player meta data loaded...');\n            get_playlist_video_progress(player, html5player);\n        });\n    }\n\n    /**\n     * Event listener for playlist.\n     * @param player\n     * @param html5player\n     */\n    const html5playerOnPlayPlaylist = (player, html5player) => {\n        html5PlayerGenericPlayerEventListener(player, html5player);\n        player.on('beforeplaylistitem', e => {\n            console.log(`Event: beforeplaylistitem -> Switching to new video ...`);\n            player.clearInterval(interval) ;\n        });\n\n        player.on('ended',(e)=>{\n            const currentTime = Math.ceil( player.duration());\n            console.log(`Video ended...`)\n            set_course_module_progress(html5player.cmid,player.mediainfo.id,currentTime, true)\n            player.clearInterval(interval);\n            // const nextVideo = player.playlist.next();\n            // console.info(`Start playing to next video : ${nextVideo.id}`)\n        })\n    }\n\n    // const initBrightCovePlayer = (course, cm, accountId, playerId, video_id) => {\n    const initBrightCovePlayer = (html5player) => {\n        html5player = JSON.parse(html5player);\n        // Make brightcove js in Require js module as bc.\n        loadBrightCoveJs(html5player.account_id, html5player.player_id);\n\n        require(['bc'], function(bc) {\n            console.info(`Brightcove player js loaded...`);\n            // Tracking is enabled for only student.\n            if (html5player.is_student ){\n                const myPlayer = videojs.getPlayer(`brightcove-player-${html5player.player_id}`);\n\n                if (html5player.video_type == VIDEO_TYPE_SINGLE_VIDEO){\n                    // Do meta loaded stuffs here.\n                    console.info('User is a student and Video type single video...');\n                    html5playerOnLoadSingleVideoMetaData(myPlayer, html5player);\n                    // Do Start playing stuffs here.\n                    html5playerOnPlaySingleVideo(myPlayer,html5player);\n                }else if( html5player.video_type == VIDEO_TYPE_PLAYLIST) {\n                    console.info('User is a student and Video type playlists video...');\n                    html5playerOnLoadPlaylistMetaData(myPlayer, html5player);\n                    onPageLoaded = true;\n                    html5playerOnPlayPlaylist(myPlayer, html5player);\n                }\n            }\n        });\n    }\n\n    return {\n       init: initBrightCovePlayer\n   }\n});"],"file":"brightcove.min.js"}